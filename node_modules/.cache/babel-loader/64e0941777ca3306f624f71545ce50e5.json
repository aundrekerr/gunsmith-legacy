{"ast":null,"code":"/**\n * covert canvas to image\n * and save the image file\n */\nvar Canvas2Image = function () {\n  // check if support sth.\n  var $support = function () {\n    var canvas = document.createElement('canvas'),\n        ctx = canvas.getContext('2d');\n    return {\n      canvas: !!ctx,\n      imageData: !!ctx.getImageData,\n      dataURL: !!canvas.toDataURL,\n      btoa: !!window.btoa\n    };\n  }();\n\n  var downloadMime = 'image/octet-stream';\n\n  function scaleCanvas(canvas, width, height) {\n    var w = canvas.width,\n        h = canvas.height;\n\n    if (width == undefined) {\n      width = w;\n    }\n\n    if (height == undefined) {\n      height = h;\n    }\n\n    var retCanvas = document.createElement('canvas');\n    var retCtx = retCanvas.getContext('2d');\n    retCanvas.width = width;\n    retCanvas.height = height;\n    retCtx.drawImage(canvas, 0, 0, w, h, 0, 0, width, height);\n    return retCanvas;\n  }\n\n  function getDataURL(canvas, type, width, height) {\n    canvas = scaleCanvas(canvas, width, height);\n    return canvas.toDataURL(type);\n  }\n\n  function saveFile(strData) {\n    document.location.href = strData;\n  }\n\n  function genImage(strData) {\n    var img = document.createElement('img');\n    img.src = strData;\n    return img;\n  }\n\n  function fixType(type) {\n    type = type.toLowerCase().replace(/jpg/i, 'jpeg');\n    var r = type.match(/png|jpeg|bmp|gif/)[0];\n    return 'image/' + r;\n  }\n\n  function encodeData(data) {\n    if (!window.btoa) {\n      throw 'btoa undefined';\n    }\n\n    var str = '';\n\n    if (typeof data == 'string') {\n      str = data;\n    } else {\n      for (var i = 0; i < data.length; i++) {\n        str += String.fromCharCode(data[i]);\n      }\n    }\n\n    return btoa(str);\n  }\n\n  function getImageData(canvas) {\n    var w = canvas.width,\n        h = canvas.height;\n    return canvas.getContext('2d').getImageData(0, 0, w, h);\n  }\n\n  function makeURI(strData, type) {\n    return 'data:' + type + ';base64,' + strData;\n  }\n  /**\n   * create bitmap image\n   * 按照规则生成图片响应头和响应体\n   */\n\n\n  var genBitmapImage = function (oData) {\n    //\n    // BITMAPFILEHEADER: http://msdn.microsoft.com/en-us/library/windows/desktop/dd183374(v=vs.85).aspx\n    // BITMAPINFOHEADER: http://msdn.microsoft.com/en-us/library/dd183376.aspx\n    //\n    var biWidth = oData.width;\n    var biHeight = oData.height;\n    var biSizeImage = biWidth * biHeight * 3;\n    var bfSize = biSizeImage + 54; // total header size = 54 bytes\n    //\n    //  typedef struct tagBITMAPFILEHEADER {\n    //  \tWORD bfType;\n    //  \tDWORD bfSize;\n    //  \tWORD bfReserved1;\n    //  \tWORD bfReserved2;\n    //  \tDWORD bfOffBits;\n    //  } BITMAPFILEHEADER;\n    //\n\n    var BITMAPFILEHEADER = [// WORD bfType -- The file type signature; must be \"BM\"\n    0x42, 0x4D, // DWORD bfSize -- The size, in bytes, of the bitmap file\n    bfSize & 0xff, bfSize >> 8 & 0xff, bfSize >> 16 & 0xff, bfSize >> 24 & 0xff, // WORD bfReserved1 -- Reserved; must be zero\n    0, 0, // WORD bfReserved2 -- Reserved; must be zero\n    0, 0, // DWORD bfOffBits -- The offset, in bytes, from the beginning of the BITMAPFILEHEADER structure to the bitmap bits.\n    54, 0, 0, 0]; //\n    //  typedef struct tagBITMAPINFOHEADER {\n    //  \tDWORD biSize;\n    //  \tLONG  biWidth;\n    //  \tLONG  biHeight;\n    //  \tWORD  biPlanes;\n    //  \tWORD  biBitCount;\n    //  \tDWORD biCompression;\n    //  \tDWORD biSizeImage;\n    //  \tLONG  biXPelsPerMeter;\n    //  \tLONG  biYPelsPerMeter;\n    //  \tDWORD biClrUsed;\n    //  \tDWORD biClrImportant;\n    //  } BITMAPINFOHEADER, *PBITMAPINFOHEADER;\n    //\n\n    var BITMAPINFOHEADER = [// DWORD biSize -- The number of bytes required by the structure\n    40, 0, 0, 0, // LONG biWidth -- The width of the bitmap, in pixels\n    biWidth & 0xff, biWidth >> 8 & 0xff, biWidth >> 16 & 0xff, biWidth >> 24 & 0xff, // LONG biHeight -- The height of the bitmap, in pixels\n    biHeight & 0xff, biHeight >> 8 & 0xff, biHeight >> 16 & 0xff, biHeight >> 24 & 0xff, // WORD biPlanes -- The number of planes for the target device. This value must be set to 1\n    1, 0, // WORD biBitCount -- The number of bits-per-pixel, 24 bits-per-pixel -- the bitmap\n    // has a maximum of 2^24 colors (16777216, Truecolor)\n    24, 0, // DWORD biCompression -- The type of compression, BI_RGB (code 0) -- uncompressed\n    0, 0, 0, 0, // DWORD biSizeImage -- The size, in bytes, of the image. This may be set to zero for BI_RGB bitmaps\n    biSizeImage & 0xff, biSizeImage >> 8 & 0xff, biSizeImage >> 16 & 0xff, biSizeImage >> 24 & 0xff, // LONG biXPelsPerMeter, unused\n    0, 0, 0, 0, // LONG biYPelsPerMeter, unused\n    0, 0, 0, 0, // DWORD biClrUsed, the number of color indexes of palette, unused\n    0, 0, 0, 0, // DWORD biClrImportant, unused\n    0, 0, 0, 0];\n    var iPadding = (4 - biWidth * 3 % 4) % 4;\n    var aImgData = oData.data;\n    var strPixelData = '';\n    var biWidth4 = biWidth << 2;\n    var y = biHeight;\n    var fromCharCode = String.fromCharCode;\n\n    do {\n      var iOffsetY = biWidth4 * (y - 1);\n      var strPixelRow = '';\n\n      for (var x = 0; x < biWidth; x++) {\n        var iOffsetX = x << 2;\n        strPixelRow += fromCharCode(aImgData[iOffsetY + iOffsetX + 2]) + fromCharCode(aImgData[iOffsetY + iOffsetX + 1]) + fromCharCode(aImgData[iOffsetY + iOffsetX]);\n      }\n\n      for (var c = 0; c < iPadding; c++) {\n        strPixelRow += String.fromCharCode(0);\n      }\n\n      strPixelData += strPixelRow;\n    } while (--y);\n\n    var strEncoded = encodeData(BITMAPFILEHEADER.concat(BITMAPINFOHEADER)) + encodeData(strPixelData);\n    return strEncoded;\n  };\n  /**\n   * saveAsImage\n   * @param canvasElement\n   * @param {String} image type\n   * @param {Number} [optional] png width\n   * @param {Number} [optional] png height\n   */\n\n\n  var saveAsImage = function (canvas, width, height, type) {\n    if ($support.canvas && $support.dataURL) {\n      if (typeof canvas == \"string\") {\n        canvas = document.getElementById(canvas);\n      }\n\n      if (type == undefined) {\n        type = 'png';\n      }\n\n      type = fixType(type);\n\n      if (/bmp/.test(type)) {\n        var data = getImageData(scaleCanvas(canvas, width, height));\n        var strData = genBitmapImage(data);\n        saveFile(makeURI(strData, downloadMime));\n      } else {\n        var strData = getDataURL(canvas, type, width, height);\n        saveFile(strData.replace(type, downloadMime));\n      }\n    }\n  };\n\n  var convertToImage = function (canvas, width, height, type) {\n    if ($support.canvas && $support.dataURL) {\n      if (typeof canvas == \"string\") {\n        canvas = document.getElementById(canvas);\n      }\n\n      if (type == undefined) {\n        type = 'png';\n      }\n\n      type = fixType(type);\n\n      if (/bmp/.test(type)) {\n        var data = getImageData(scaleCanvas(canvas, width, height));\n        var strData = genBitmapImage(data);\n        return genImage(makeURI(strData, 'image/bmp'));\n      } else {\n        var strData = getDataURL(canvas, type, width, height);\n        return genImage(strData);\n      }\n    }\n  };\n\n  return {\n    saveAsImage: saveAsImage,\n    saveAsPNG: function (canvas, width, height) {\n      return saveAsImage(canvas, width, height, 'png');\n    },\n    saveAsJPEG: function (canvas, width, height) {\n      return saveAsImage(canvas, width, height, 'jpeg');\n    },\n    saveAsGIF: function (canvas, width, height) {\n      return saveAsImage(canvas, width, height, 'gif');\n    },\n    saveAsBMP: function (canvas, width, height) {\n      return saveAsImage(canvas, width, height, 'bmp');\n    },\n    convertToImage: convertToImage,\n    convertToPNG: function (canvas, width, height) {\n      return convertToImage(canvas, width, height, 'png');\n    },\n    convertToJPEG: function (canvas, width, height) {\n      return convertToImage(canvas, width, height, 'jpeg');\n    },\n    convertToGIF: function (canvas, width, height) {\n      return convertToImage(canvas, width, height, 'gif');\n    },\n    convertToBMP: function (canvas, width, height) {\n      return convertToImage(canvas, width, height, 'bmp');\n    }\n  };\n}();","map":{"version":3,"sources":["/Users/aundrekerr/Documents/GitHub/gunsmith/node_modules/canvas2image/canvas2image.js"],"names":["Canvas2Image","$support","canvas","document","createElement","ctx","getContext","imageData","getImageData","dataURL","toDataURL","btoa","window","downloadMime","scaleCanvas","width","height","w","h","undefined","retCanvas","retCtx","drawImage","getDataURL","type","saveFile","strData","location","href","genImage","img","src","fixType","toLowerCase","replace","r","match","encodeData","data","str","i","length","String","fromCharCode","makeURI","genBitmapImage","oData","biWidth","biHeight","biSizeImage","bfSize","BITMAPFILEHEADER","BITMAPINFOHEADER","iPadding","aImgData","strPixelData","biWidth4","y","iOffsetY","strPixelRow","x","iOffsetX","c","strEncoded","concat","saveAsImage","getElementById","test","convertToImage","saveAsPNG","saveAsJPEG","saveAsGIF","saveAsBMP","convertToPNG","convertToJPEG","convertToGIF","convertToBMP"],"mappings":"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","sourcesContent":["/**\n * covert canvas to image\n * and save the image file\n */\n\nvar Canvas2Image = function () {\n\n\t// check if support sth.\n\tvar $support = function () {\n\t\tvar canvas = document.createElement('canvas'),\n\t\t\tctx = canvas.getContext('2d');\n\n\t\treturn {\n\t\t\tcanvas: !!ctx,\n\t\t\timageData: !!ctx.getImageData,\n\t\t\tdataURL: !!canvas.toDataURL,\n\t\t\tbtoa: !!window.btoa\n\t\t};\n\t}();\n\n\tvar downloadMime = 'image/octet-stream';\n\n\tfunction scaleCanvas (canvas, width, height) {\n\t\tvar w = canvas.width,\n\t\t\th = canvas.height;\n\t\tif (width == undefined) {\n\t\t\twidth = w;\n\t\t}\n\t\tif (height == undefined) {\n\t\t\theight = h;\n\t\t}\n\n\t\tvar retCanvas = document.createElement('canvas');\n\t\tvar retCtx = retCanvas.getContext('2d');\n\t\tretCanvas.width = width;\n\t\tretCanvas.height = height;\n\t\tretCtx.drawImage(canvas, 0, 0, w, h, 0, 0, width, height);\n\t\treturn retCanvas;\n\t}\n\n\tfunction getDataURL (canvas, type, width, height) {\n\t\tcanvas = scaleCanvas(canvas, width, height);\n\t\treturn canvas.toDataURL(type);\n\t}\n\n\tfunction saveFile (strData) {\n\t\tdocument.location.href = strData;\n\t}\n\n\tfunction genImage(strData) {\n\t\tvar img = document.createElement('img');\n\t\timg.src = strData;\n\t\treturn img;\n\t}\n\tfunction fixType (type) {\n\t\ttype = type.toLowerCase().replace(/jpg/i, 'jpeg');\n\t\tvar r = type.match(/png|jpeg|bmp|gif/)[0];\n\t\treturn 'image/' + r;\n\t}\n\tfunction encodeData (data) {\n\t\tif (!window.btoa) { throw 'btoa undefined' }\n\t\tvar str = '';\n\t\tif (typeof data == 'string') {\n\t\t\tstr = data;\n\t\t} else {\n\t\t\tfor (var i = 0; i < data.length; i ++) {\n\t\t\t\tstr += String.fromCharCode(data[i]);\n\t\t\t}\n\t\t}\n\n\t\treturn btoa(str);\n\t}\n\tfunction getImageData (canvas) {\n\t\tvar w = canvas.width,\n\t\t\th = canvas.height;\n\t\treturn canvas.getContext('2d').getImageData(0, 0, w, h);\n\t}\n\tfunction makeURI (strData, type) {\n\t\treturn 'data:' + type + ';base64,' + strData;\n\t}\n\n\n\t/**\n\t * create bitmap image\n\t * 按照规则生成图片响应头和响应体\n\t */\n\tvar genBitmapImage = function (oData) {\n\n\t\t//\n\t\t// BITMAPFILEHEADER: http://msdn.microsoft.com/en-us/library/windows/desktop/dd183374(v=vs.85).aspx\n\t\t// BITMAPINFOHEADER: http://msdn.microsoft.com/en-us/library/dd183376.aspx\n\t\t//\n\n\t\tvar biWidth  = oData.width;\n\t\tvar biHeight\t= oData.height;\n\t\tvar biSizeImage = biWidth * biHeight * 3;\n\t\tvar bfSize  = biSizeImage + 54; // total header size = 54 bytes\n\n\t\t//\n\t\t//  typedef struct tagBITMAPFILEHEADER {\n\t\t//  \tWORD bfType;\n\t\t//  \tDWORD bfSize;\n\t\t//  \tWORD bfReserved1;\n\t\t//  \tWORD bfReserved2;\n\t\t//  \tDWORD bfOffBits;\n\t\t//  } BITMAPFILEHEADER;\n\t\t//\n\t\tvar BITMAPFILEHEADER = [\n\t\t\t// WORD bfType -- The file type signature; must be \"BM\"\n\t\t\t0x42, 0x4D,\n\t\t\t// DWORD bfSize -- The size, in bytes, of the bitmap file\n\t\t\tbfSize & 0xff, bfSize >> 8 & 0xff, bfSize >> 16 & 0xff, bfSize >> 24 & 0xff,\n\t\t\t// WORD bfReserved1 -- Reserved; must be zero\n\t\t\t0, 0,\n\t\t\t// WORD bfReserved2 -- Reserved; must be zero\n\t\t\t0, 0,\n\t\t\t// DWORD bfOffBits -- The offset, in bytes, from the beginning of the BITMAPFILEHEADER structure to the bitmap bits.\n\t\t\t54, 0, 0, 0\n\t\t];\n\n\t\t//\n\t\t//  typedef struct tagBITMAPINFOHEADER {\n\t\t//  \tDWORD biSize;\n\t\t//  \tLONG  biWidth;\n\t\t//  \tLONG  biHeight;\n\t\t//  \tWORD  biPlanes;\n\t\t//  \tWORD  biBitCount;\n\t\t//  \tDWORD biCompression;\n\t\t//  \tDWORD biSizeImage;\n\t\t//  \tLONG  biXPelsPerMeter;\n\t\t//  \tLONG  biYPelsPerMeter;\n\t\t//  \tDWORD biClrUsed;\n\t\t//  \tDWORD biClrImportant;\n\t\t//  } BITMAPINFOHEADER, *PBITMAPINFOHEADER;\n\t\t//\n\t\tvar BITMAPINFOHEADER = [\n\t\t\t// DWORD biSize -- The number of bytes required by the structure\n\t\t\t40, 0, 0, 0,\n\t\t\t// LONG biWidth -- The width of the bitmap, in pixels\n\t\t\tbiWidth & 0xff, biWidth >> 8 & 0xff, biWidth >> 16 & 0xff, biWidth >> 24 & 0xff,\n\t\t\t// LONG biHeight -- The height of the bitmap, in pixels\n\t\t\tbiHeight & 0xff, biHeight >> 8  & 0xff, biHeight >> 16 & 0xff, biHeight >> 24 & 0xff,\n\t\t\t// WORD biPlanes -- The number of planes for the target device. This value must be set to 1\n\t\t\t1, 0,\n\t\t\t// WORD biBitCount -- The number of bits-per-pixel, 24 bits-per-pixel -- the bitmap\n\t\t\t// has a maximum of 2^24 colors (16777216, Truecolor)\n\t\t\t24, 0,\n\t\t\t// DWORD biCompression -- The type of compression, BI_RGB (code 0) -- uncompressed\n\t\t\t0, 0, 0, 0,\n\t\t\t// DWORD biSizeImage -- The size, in bytes, of the image. This may be set to zero for BI_RGB bitmaps\n\t\t\tbiSizeImage & 0xff, biSizeImage >> 8 & 0xff, biSizeImage >> 16 & 0xff, biSizeImage >> 24 & 0xff,\n\t\t\t// LONG biXPelsPerMeter, unused\n\t\t\t0,0,0,0,\n\t\t\t// LONG biYPelsPerMeter, unused\n\t\t\t0,0,0,0,\n\t\t\t// DWORD biClrUsed, the number of color indexes of palette, unused\n\t\t\t0,0,0,0,\n\t\t\t// DWORD biClrImportant, unused\n\t\t\t0,0,0,0\n\t\t];\n\n\t\tvar iPadding = (4 - ((biWidth * 3) % 4)) % 4;\n\n\t\tvar aImgData = oData.data;\n\n\t\tvar strPixelData = '';\n\t\tvar biWidth4 = biWidth<<2;\n\t\tvar y = biHeight;\n\t\tvar fromCharCode = String.fromCharCode;\n\n\t\tdo {\n\t\t\tvar iOffsetY = biWidth4*(y-1);\n\t\t\tvar strPixelRow = '';\n\t\t\tfor (var x = 0; x < biWidth; x++) {\n\t\t\t\tvar iOffsetX = x<<2;\n\t\t\t\tstrPixelRow += fromCharCode(aImgData[iOffsetY+iOffsetX+2]) +\n\t\t\t\t\t\t\t   fromCharCode(aImgData[iOffsetY+iOffsetX+1]) +\n\t\t\t\t\t\t\t   fromCharCode(aImgData[iOffsetY+iOffsetX]);\n\t\t\t}\n\n\t\t\tfor (var c = 0; c < iPadding; c++) {\n\t\t\t\tstrPixelRow += String.fromCharCode(0);\n\t\t\t}\n\n\t\t\tstrPixelData += strPixelRow;\n\t\t} while (--y);\n\n\t\tvar strEncoded = encodeData(BITMAPFILEHEADER.concat(BITMAPINFOHEADER)) + encodeData(strPixelData);\n\n\t\treturn strEncoded;\n\t};\n\n\t/**\n\t * saveAsImage\n\t * @param canvasElement\n\t * @param {String} image type\n\t * @param {Number} [optional] png width\n\t * @param {Number} [optional] png height\n\t */\n\tvar saveAsImage = function (canvas, width, height, type) {\n\t\tif ($support.canvas && $support.dataURL) {\n\t\t\tif (typeof canvas == \"string\") { canvas = document.getElementById(canvas); }\n\t\t\tif (type == undefined) { type = 'png'; }\n\t\t\ttype = fixType(type);\n\t\t\tif (/bmp/.test(type)) {\n\t\t\t\tvar data = getImageData(scaleCanvas(canvas, width, height));\n\t\t\t\tvar strData = genBitmapImage(data);\n\t\t\t\tsaveFile(makeURI(strData, downloadMime));\n\t\t\t} else {\n\t\t\t\tvar strData = getDataURL(canvas, type, width, height);\n\t\t\t\tsaveFile(strData.replace(type, downloadMime));\n\t\t\t}\n\t\t}\n\t};\n\n\tvar convertToImage = function (canvas, width, height, type) {\n\t\tif ($support.canvas && $support.dataURL) {\n\t\t\tif (typeof canvas == \"string\") { canvas = document.getElementById(canvas); }\n\t\t\tif (type == undefined) { type = 'png'; }\n\t\t\ttype = fixType(type);\n\n\t\t\tif (/bmp/.test(type)) {\n\t\t\t\tvar data = getImageData(scaleCanvas(canvas, width, height));\n\t\t\t\tvar strData = genBitmapImage(data);\n\t\t\t\treturn genImage(makeURI(strData, 'image/bmp'));\n\t\t\t} else {\n\t\t\t\tvar strData = getDataURL(canvas, type, width, height);\n\t\t\t\treturn genImage(strData);\n\t\t\t}\n\t\t}\n\t};\n\n\n\n\treturn {\n\t\tsaveAsImage: saveAsImage,\n\t\tsaveAsPNG: function (canvas, width, height) {\n\t\t\treturn saveAsImage(canvas, width, height, 'png');\n\t\t},\n\t\tsaveAsJPEG: function (canvas, width, height) {\n\t\t\treturn saveAsImage(canvas, width, height, 'jpeg');\n\t\t},\n\t\tsaveAsGIF: function (canvas, width, height) {\n\t\t\treturn saveAsImage(canvas, width, height, 'gif');\n\t\t},\n\t\tsaveAsBMP: function (canvas, width, height) {\n\t\t\treturn saveAsImage(canvas, width, height, 'bmp');\n\t\t},\n\n\t\tconvertToImage: convertToImage,\n\t\tconvertToPNG: function (canvas, width, height) {\n\t\t\treturn convertToImage(canvas, width, height, 'png');\n\t\t},\n\t\tconvertToJPEG: function (canvas, width, height) {\n\t\t\treturn convertToImage(canvas, width, height, 'jpeg');\n\t\t},\n\t\tconvertToGIF: function (canvas, width, height) {\n\t\t\treturn convertToImage(canvas, width, height, 'gif');\n\t\t},\n\t\tconvertToBMP: function (canvas, width, height) {\n\t\t\treturn convertToImage(canvas, width, height, 'bmp');\n\t\t}\n\t};\n\n}();\n"]},"metadata":{},"sourceType":"script"}